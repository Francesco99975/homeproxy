# Local Traefik Proxy with Self-Signed Certificates

This guide provides a step-by-step tutorial on setting up a local Traefik proxy using Docker and self-signed certificates generated by a [Smallstep Certificate Authority](https://smallstep.com/docs/step-ca). The setup will create a local domain with HTTPS enabled, perfect for local development and testing environments.

## Prerequisites

1. **Docker** and **Docker Compose** installed on your machine.
2. Basic knowledge of Docker, Docker Compose, and networking concepts.
3. A working knowledge of editing YAML files.

## Overview

We will set up:

- **Step CA** as a certificate authority to generate self-signed certificates.
- **Traefik** as a reverse proxy and load balancer with HTTPS enabled for local domains.

### Project Structure

Here's the structure of the project:

```plaintext
project-directory/
├── docker-compose.yml     # Main Docker Compose file
├── traefik.toml           # Traefik configuration file
└── letsencrypt/
    └── acme.json          # Cert Store
└── data/
    └── step-ca/           # Directory to store Step CA config and certs
```

## Step-by-Step Setup

### Step 1: Create Necessary Files and Folders

1. Clone this repository or create a new directory.

```
git clone https://github.com/Francesco99975/homeproxy
```

2. Create a `letsencrypt/acme.json` and `data/step-ca` directory to store Certs and Step CA data.

```
mkdir -p "$PWD/letsencrypt"

touch "$PWD/letsencrypt/acme.json"
```

```
mkdir -p "$PWD/data/step-ca"

sudo chown -R 1000:1000 "$PWD/data/step-ca"
```

### Step 2: Configure `docker-compose.yml`

Edit the [`docker-compose.yml`](docker-compose.yml) file to define the services required for the setup. You can reference the complete configuration.

### Step 3: Configure `traefik.toml`

Edit the [`traefik.toml`](traefik.toml) file to set up Traefik's entry points, provider settings, certificate resolver, and enable the dashboard with authentication. You can reference the complete configuration.

### Step 4: Initialize Step-CA

```
mkdir -p "$PWD/data/step-ca" && sudo chown -R 1000:1000 "$PWD/data/step-ca"
```

```
docker run --rm -it -v "$PWD/data/step-ca:/home/step" smallstep/step-ca step ca init
```
### Input Answers:
### What would you like to name your new PKI?
> name of your container
### What DNS names or IP addresses will clients use to reach your CA?
> step-ca,localhost
### 
> :(literal colon) followed by exposed port of your container
### What would you like to name the CA's first provisioner?
> yourname@server.com
### Set a Password
> choose a Password or save the generated one for the next step

### Step 5: Set your password

```
echo <your password here> | sudo tee "$PWD/data/step-ca/secrets/password"
```

```
sudo chown -R 1000:1000 "$PWD/data/step-ca/secrets/password"
```

### Step 6: Run the Containers

Run the following command to start all the containers defined in your `docker-compose.yml` file:

```sh
docker-compose up -d
```

> you can check if the step-ca container is running correctly by sending a request to: https://localhost:9000/health

```
curl -k https://localhost:9000/health
```

> -k is used to ignore certificate checks for now since acme is not setup and cert is not trusted by system

### Step 7: Enable the ACME Provisioner

```
docker-compose exec step-ca step ca provisioner add acme --type ACME
```

```
docker-compose restart
```

### Step 8: Access the Traefik Dashboard

Once Traefik is up, access the dashboard at `https://traefik.example.local` (replace `example.local` with your domain). Log in with the credentials set in `traefik.toml`.

### Step 9: Add Certificate to system trust store

> Get fingerprint from data/step-ca/config/defaults.json

```
step ca bootstrap --ca-url https://localhost:9000 --install --fingerprint <fingerprint>
```

> Test if it worked by sending a request to https://localhost:9000 this time without ignoring certificate check

```
curl https://localhost:9000
```

### Attaching Services to the Proxy

To attach other services to your Traefik proxy, you need to configure specific labels in your service's `docker-compose.yml` file. Below is an example configuration for a service [(e.g., Jellyfin)](services/docker-compose_jellyfin.yml) with the necessary Traefik labels:

```yaml
labels:
  - "traefik.enable=true" # Enable Traefik for this service
  - "traefik.http.routers.jellyfin.rule=Host(`jellyfin.example.com`)" # Define the routing rule based on the host
  - "traefik.http.routers.jellyfin.entrypoints=web,websecure" # Specify the entry points for HTTP and HTTPS
  - "traefik.http.routers.jellyfin.tls=true" # Enable TLS for this router
  - "traefik.http.services.jellyfin.loadbalancer.server.port=8096" # Define the port on which the service is running
  - "traefik.http.routers.jellyfin.tls.certresolver=stepca" # Use the specified certificate resolver for TLS
  - "traefik.http.routers.jellyfin.tls.domains[0].main=jellyfin.example.com" # Define the main domain for TLS
  - "traefik.port=80" # Specify the port that Traefik should use to communicate with the service
```
